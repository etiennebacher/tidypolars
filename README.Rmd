---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# tidypolars

<!-- badges: start -->
[![check](https://github.com/etiennebacher/tidypolars/actions/workflows/check.yml/badge.svg)](https://github.com/etiennebacher/tidypolars/actions/workflows/check.yml)
[![tidypolars status badge](https://etiennebacher.r-universe.dev/badges/tidypolars)](https://etiennebacher.r-universe.dev/tidypolars)
[![Codecov test coverage](https://codecov.io/gh/etiennebacher/tidypolars/branch/main/graph/badge.svg)](https://app.codecov.io/gh/etiennebacher/tidypolars?branch=main)
<!-- badges: end -->


---

:warning: If you're looking for the Python package "tidypolars",
you're on the wrong repo. The right one is here: [markfairbanks/tidypolars](https://github.com/markfairbanks/tidypolars) :warning:

---

## Installation

`tidypolars` is built on `polars`, which is not available on CRAN. This implies 
that `tidypolars` also can't be on CRAN. 

That said, there are still several ways to install `tidypolars`. Depending on
your OS, the procedure is slightly different.

### Windows or macOS

```{r eval=FALSE}
install.packages('tidypolars', repos = c('https://etiennebacher.r-universe.dev'))

#### OR

# install.packages("remotes")
remotes::install_github(
  "etiennebacher/tidypolars", 
  repos = c("https://rpolars.r-universe.dev", getOption("repos"))
)

#### OR

# install.packages("pak")
pak::repo_add("https://rpolars.r-universe.dev")
pak::pkg_install("etiennebacher/tidypolars")
```

### Linux

```{r eval=FALSE}
# install.packages("remotes")
remotes::install_github(
  "etiennebacher/tidypolars", 
  repos = c("https://rpolars.r-universe.dev/bin/linux/jammy/4.3", getOption("repos"))
)

#### OR

# install.packages("pak")
pak::repo_add("https://rpolars.r-universe.dev/bin/linux/jammy/4.3")
pak::pkg_install("etiennebacher/tidypolars")
```


## Motivation

`polars` (both the Rust source and the R implementation) are amazing packages.
I won't argue here for the interest of using `polars`, there are already a lot 
of resources on [its website](https://rpolars.github.io/).

One characteristic of `polars` is that its syntax is 1) quite verbose, and 
2) very close to the `pandas` syntax in Python. While this makes it easy
to read, it is **yet another syntax to learn** for R users that are accustomed 
so far to either base R, `data.table` or the `tidyverse`.

The objective of `tidypolars` is to **provide functions that are very close to
the `tidyverse` ones** but that call the `polars` functions under the hood so 
that we don't lose any of its capacities. 


## Example

Suppose that you already have some code that uses `dplyr`:

```{r}
library(dplyr, warn.conflicts = FALSE)

iris |> 
  select(starts_with(c("Sep", "Pet"))) |> 
  mutate(
    petal_type = ifelse((Petal.Length / Petal.Width) > 3, "long", "large")
  ) |> 
  filter(between(Sepal.Length, 4.5, 5.5)) |> 
  head()
```

With `tidypolars`, you can provide a Polars `DataFrame` or `LazyFrame` and keep 
the exact same code:

```{r}
library(tidypolars)

iris |> 
  as_polars() |> 
  select(starts_with(c("Sep", "Pet"))) |> 
  mutate(
    petal_type = ifelse((Petal.Length / Petal.Width) > 3, "long", "large")
  ) |> 
  filter(between(Sepal.Length, 4.5, 5.5)) |> 
  head()
```

If you're used to the `tidyverse` functions and syntax, this will feel much 
easier to read than the pure `polars` syntax:

```{r}
library(polars)

# polars syntax
pl$DataFrame(iris)$
  select(c("Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width"))$
  with_columns(
    pl$when(
      (pl$col("Petal.Length") / pl$col("Petal.Width") > 3)
    )$then("long")$
      otherwise("large")$
      alias("petal_type")
  )$
  filter(pl$col("Sepal.Length")$is_between(4.5, 5.5))$
  head(6)
```

Don't worry about losing performance compared to the pure `polars` syntax,
`tidypolars` is just as fast:

```{r}
large_iris <- data.table::rbindlist(rep(list(iris), 50000))
large_iris_pl <- as_polars(large_iris, lazy = TRUE)

bench::mark(
  polars = {
    large_iris_pl$
      select(c("Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width"))$
      with_columns(
        pl$when(
          (pl$col("Petal.Length") / pl$col("Petal.Width") > 3)
        )$then("long")$
          otherwise("large")$
          alias("petal_type")
      )$
      filter(pl$col("Sepal.Length")$is_between(4.5, 5.5))$
      collect()
  },
  tidypolars = {
    large_iris_pl |>
      select(starts_with(c("Sep", "Pet"))) |>
      mutate(
        petal_type = ifelse((Petal.Length / Petal.Width) > 3, "long", "large")
      ) |> 
      filter(between(Sepal.Length, 4.5, 5.5)) |> 
      collect()
  },
  dplyr = {
    large_iris |>
      select(starts_with(c("Sep", "Pet"))) |>
      mutate(
        petal_type = ifelse((Petal.Length / Petal.Width) > 3, "long", "large")
      ) |>
      filter(between(Sepal.Length, 4.5, 5.5))
  },
  check = FALSE,
  iterations = 10
)
```
